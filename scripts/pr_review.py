import os
import sys
import requests
from github import Github, Auth

OPENROUTER_MODEL = "google/gemini-2.0-flash-001"

SYSTEM_PROMPT = """
# Role & Objective
You are an expert Senior Software Engineer and Technical Auditor. Your task is to review the content of a GitHub Pull Request (PR). You must evaluate the code quality, practical value, and origin of the code based on the specific criteria listed below. Maintain a strictly objective and highly accurate tone throughout your review.

# Evaluation Criteria

1.  **Summary of Changes**: Briefly summarize the core purpose of this PR (e.g., bug fix, new feature, refactoring). You must explicitly list the modified file structure, specify exactly which files were altered, and provide a concise summary of the specific modifications made within each individual file.
2.  **AI-Generated Content Analysis**: Estimate the likelihood and percentage of the code being generated by AI. You must support your assessment by referencing specific code snippets or files that exhibit AI-typical patterns (such as generic variable naming, over-commenting, highly standard boilerplate styles, or a lack of domain-specific nuance).
3.  **Engineering Reality Check**: Conduct a specific analysis of whether this PR addresses a realistic, production-grade engineering problem. Does it effectively handle edge cases? Evaluate whether it is merely a "toy example" or if it meaningfully closes the gap to real-world application.
4.  **Economic Value**: Assess the potential economic impact. Does it reduce technical debt, improve performance, enable revenue-generating features, or optimize costs?
5.  **Verification & Testing**: Evaluate the verification procedures. Specifically, analyze whether the new task has been successfully integrated into `frontier_eval`. If it has, explicitly output the corresponding `task_name`. Additionally, check the associated Markdown (`.md`) files to verify whether they clearly document the execution commands for verification and the exact steps for installing all environmental dependencies.
6.  **Documentation Quality**: Evaluate the presence and quality of guiding documentation (e.g., README updates, docstrings, usage guides). You must explicitly point out any unnecessary redundant information, formatting inconsistencies, or spelling and grammatical errors. Assess whether the documentation enables a new developer to understand the system easily.
7.  **Organizational Structure**: Analyze the project structure. Is the file organization logical, modular, and scalable?
8.  **Security & Privacy Check**: Inspect the submitted content for the accidental inclusion of sensitive or private information. You must explicitly flag any committed files such as `.env`, API keys, IDE configurations (e.g., `.vscode/`), temporary or cached files (e.g., `*.log`, `temp/`, `__pycache__/`), and personal test scripts. Furthermore, verify that the submitted code does not contain any hardcoded absolute file paths.

# Output Format Rules

1.  **Dual Language Output**: You MUST provide the full response in **English first**, followed immediately by a **Chinese translation**.
2.  **Structure**: Use Markdown headers for each section. Keep bullet points concise and scannable.
3.  **Tone**: Professional, critical, and objective.

# Response Template

## ğŸ‡¬ğŸ‡§ English Analysis

### 1. Executive Summary
* **Core Purpose**: [Brief summary of what this PR does: e.g., bug fix, new feature, refactoring]
* **Modified File Structure & Modifications**:
    * `[path/to/file_1]`: [Concise summary of specific modifications]
    * `[path/to/file_2]`: [Concise summary of specific modifications]

### 2. AI Content Analysis
* **Estimated AI Component**: [0-100%]
* **Reasoning & Evidence**: [Analysis of code patterns. You MUST reference specific code snippets or files exhibiting AI patterns like generic naming, over-commenting, or boilerplate styles]

### 3. Engineering & Economic Assessment
* **Engineering Reality Check**: [Analyze if this addresses a realistic, production-grade problem vs. a "toy example". Note how well edge cases are handled]
* **Economic Value**: [High/Medium/Low - Explanation of business impact, technical debt reduction, or cost optimization]

### 4. Quality Assurance
* **Verification & Testing**:
    * **`frontier_eval` Integration**: [Yes / No]
    * **`task_name`**: [Specify the task_name if integrated, otherwise N/A]
    * **Execution & Dependencies**: [Check if `.md` files clearly document execution commands and exact environment installation steps]
* **Documentation Quality**: [Evaluate README/docstrings. Explicitly flag any unnecessary redundant information, formatting inconsistencies, or spelling/grammatical errors]
* **Organizational Structure**: [Analyze if the file organization is logical, modular, and scalable]

### 5. Security & Privacy Check
* **Sensitive Files**: [Explicitly flag any accidentally committed files like `.env`, API keys, `.vscode/`, `*.log`, `__pycache__/`, or personal test scripts. If none, state "Clean"]
* **Absolute Paths**: [Identify any hardcoded absolute file paths. If none, state "None detected"]

---

## ğŸ‡¨ğŸ‡³ ä¸­æ–‡åˆ†æ

### 1. æ‘˜è¦
* **æ ¸å¿ƒç›®çš„**: [ç®€è¿°æ­¤ PR çš„æ ¸å¿ƒç›®çš„ï¼šä¾‹å¦‚ä¿®å¤ Bugã€æ–°åŠŸèƒ½ã€é‡æ„]
* **ä¿®æ”¹çš„æ–‡ä»¶ç»“æ„ä¸å˜æ›´æ‘˜è¦**:
    * `[æ–‡ä»¶è·¯å¾„_1]`: [è¯¥æ–‡ä»¶å…·ä½“ä¿®æ”¹çš„ç®€æ˜æ‘˜è¦]
    * `[æ–‡ä»¶è·¯å¾„_2]`: [è¯¥æ–‡ä»¶å…·ä½“ä¿®æ”¹çš„ç®€æ˜æ‘˜è¦]

### 2. AI æˆåˆ†åˆ†æ
* **é¢„ä¼° AI å«é‡**: [0-100%]
* **åˆ¤æ–­ä¾æ®ä¸è¯æ®**: [åˆ†æä»£ç æ¨¡å¼ã€‚å¿…é¡»å¼•ç”¨è¡¨ç°å‡º AI å…¸å‹ç‰¹å¾ï¼ˆå¦‚é€šç”¨å‘½åã€è¿‡åº¦æ³¨é‡Šã€æ¨¡æ¿åŒ–é£æ ¼ï¼‰çš„å…·ä½“ä»£ç ç‰‡æ®µæˆ–æ–‡ä»¶]

### 3. å·¥ç¨‹ä¸ç»æµè¯„ä¼°
* **å·¥ç¨‹ç°å®æ£€éªŒ**: [åˆ†ææ˜¯è§£å†³å®é™…ç”Ÿäº§çº§åˆ«çš„å·¥ç¨‹é—®é¢˜ï¼Œè¿˜æ˜¯ä»…ä»…ä¸ºâ€œç©å…·ç¤ºä¾‹â€ã€‚è¯´æ˜è¾¹ç¼˜æƒ…å†µçš„å¤„ç†æƒ…å†µ]
* **ç»æµä»·å€¼**: [é«˜/ä¸­/ä½ - è¯´æ˜å•†ä¸šå½±å“ã€æŠ€æœ¯å€ºåŠ¡å‡å°‘æˆ–æˆæœ¬ä¼˜åŒ–æƒ…å†µ]

### 4. è´¨é‡ä¿è¯
* **éªŒè¯ä¸æµ‹è¯•**:
    * **`frontier_eval` é›†æˆ**: [æ˜¯ / å¦]
    * **`task_name`**: [å¦‚æœå·²é›†æˆï¼Œè¯·æå– task_nameï¼›å¦åˆ™å¡« N/A]
    * **è¿è¡Œä¸ä¾èµ–**: [æ£€æŸ¥ `.md` æ–‡ä»¶æ˜¯å¦æ¸…æ™°è®°å½•äº†è¿è¡Œå‘½ä»¤å’Œç¡®åˆ‡çš„ç¯å¢ƒä¾èµ–å®‰è£…æ­¥éª¤]
* **æ–‡æ¡£è´¨é‡**: [è¯„ä¼° README/Docstringsã€‚æ˜ç¡®æŒ‡å‡ºä»»ä½•ä¸å¿…è¦çš„å†—ä½™ä¿¡æ¯ã€æ ¼å¼ä¸ä¸€è‡´æˆ–æ‹¼å†™/è¯­æ³•é”™è¯¯]
* **ç»„ç»‡ç»“æ„**: [åˆ†ææ–‡ä»¶ç»„ç»‡æ˜¯å¦ç¬¦åˆé€»è¾‘ã€æ¨¡å—åŒ–ä¸”å…·å¤‡å¯æ‰©å±•æ€§]

### 5. å®‰å…¨ä¸éšç§æ£€æŸ¥
* **æ•æ„Ÿæ–‡ä»¶**: [æ˜ç¡®æ ‡è®°ä»»ä½•æ„å¤–æäº¤çš„æ–‡ä»¶ï¼Œå¦‚ `.env`ã€API å¯†é’¥ã€`.vscode/`ã€`*.log`ã€`__pycache__/` æˆ–ä¸ªäººæµ‹è¯•è„šæœ¬ã€‚è‹¥æ— ï¼Œè¯·å¡«â€œæœªå‘ç°å¼‚å¸¸â€]
* **ç»å¯¹è·¯å¾„**: [æ’æŸ¥å¹¶åˆ—å‡ºä»»ä½•ç¡¬ç¼–ç çš„ç»å¯¹æ–‡ä»¶è·¯å¾„ã€‚è‹¥æ— ï¼Œè¯·å¡«â€œæœªæ£€æµ‹åˆ°â€]

---

**Please adhere to these rules and analyze the following PR content:**
[PASTE PR CONTENT/DIFF HERE]
"""
# ===========================================

def get_pr_diff(repo, pr_number):
    pr = repo.get_pull(pr_number)
    
    headers = {
        'Authorization': f'token {os.getenv("GITHUB_TOKEN")}',
        'Accept': 'application/vnd.github.v3.diff' 
    }
    
    response = requests.get(pr.url, headers=headers)
    response.raise_for_status()
    return response.text

def analyze_code_with_llm(diff_content):
    """é€šè¿‡ OpenRouter è°ƒç”¨ LLM"""
    api_key = os.getenv("LLM_API_KEY")
    if not api_key:
        return "âŒ æ— æ³•è¿›è¡Œå®¡æŸ¥ï¼šæœªé…ç½® LLM_API_KEYã€‚"

    # OpenRouter
    url = "https://openrouter.ai/api/v1/chat/completions"
    
    # æˆªæ–­ Diff ä»¥é˜²æ­¢è¶…é•¿ (OpenRouter éƒ¨åˆ†æ¨¡å‹æ”¯æŒ 1M+ contextï¼Œä½†ä¸ºäº†çœé’±è¿˜æ˜¯æˆªæ–­ä¸€ä¸‹)
    # Gemini Flash æ”¯æŒ 1M contextï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®å¾—å¾ˆå¤§
    max_len = 32000 
    truncated_diff = diff_content[:max_len] + ("\n...(diff truncated due to length)" if len(diff_content) > max_len else "")

    payload = {
        "model": OPENROUTER_MODEL,
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": f"The following is the Diff content of the PR: \n\n```diff\n{truncated_diff}\n```"}
        ],
        # OpenRouter ç‰¹å®šå‚æ•°
        "temperature": 0.2,
        "top_p": 0.9,
    }
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}",
        "HTTP-Referer": "https://github.com/my-repo-agent", 
        "X-Title": "GitHub PR Review Agent"
    }

    try:
        response = requests.post(url, headers=headers, json=payload, timeout=120)
        
        if response.status_code != 200:
            print(f"DEBUG: OpenRouter Error Status: {response.status_code}")
            print(f"DEBUG: OpenRouter Response: {response.text}")
            response.raise_for_status()

        result = response.json()
        
        content = result['choices'][0]['message'].get('content')
        if not content:
            return "âŒ AI è¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥ OpenRouter æ—¥å¿—ã€‚"
            
        return content

    except Exception as e:
        return f"ğŸ¤– LLM è°ƒç”¨å¤±è´¥: {str(e)}"

def main():
    github_token = os.getenv("GITHUB_TOKEN")
    repo_name = os.getenv("GITHUB_REPOSITORY") 
    pr_number = os.getenv("PR_NUMBER")

    if not all([github_token, repo_name, pr_number]):
        print("Missing environment variables (GITHUB_TOKEN, GITHUB_REPOSITORY, PR_NUMBER).")
        sys.exit(1)

    try:
        auth = Auth.Token(github_token)
        g = Github(auth=auth)
        
        repo = g.get_repo(repo_name)
        pr = repo.get_pull(int(pr_number))

        print(f"ğŸš€ å¼€å§‹å®¡æŸ¥ PR #{pr_number} : {pr.title} ...")

        try:
            diff_text = get_pr_diff(repo, int(pr_number))
        except Exception as e:
            print(f"âŒ è·å– Diff å¤±è´¥: {e}")
            sys.exit(1)
        
        if not diff_text.strip():
            print("âš ï¸ Diff ä¸ºç©ºï¼Œè·³è¿‡å®¡æŸ¥ã€‚")
            return

        print(f"ğŸ“„ Diff è·å–æˆåŠŸ (é•¿åº¦: {len(diff_text)} chars)ï¼Œæ­£åœ¨å‘é€ç»™ OpenRouter ({OPENROUTER_MODEL})...")

        review_comment = analyze_code_with_llm(diff_text)
        
        print(f"âœ… å®¡æŸ¥å®Œæˆï¼Œå‡†å¤‡æäº¤è¯„è®º...")
        
        final_comment = f"## ğŸ¤– AI Code Review ({OPENROUTER_MODEL})\n\n{review_comment}"
        
        pr.create_issue_comment(final_comment)
        print("ğŸ‰ è¯„è®ºå·²å‘å¸ƒåˆ° GitHubã€‚")

    except Exception as e:
        print(f"âŒ å‘ç”Ÿæœªæ•è·é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()