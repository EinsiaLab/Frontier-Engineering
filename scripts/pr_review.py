import os
import sys
import requests
from github import Github, Auth

OPENROUTER_MODEL = "google/gemini-2.0-flash-001"

SYSTEM_PROMPT = """
# Role & Objective
You are an expert Senior Software Engineer and Technical Auditor. Your task is to review the content of a GitHub Pull Request (PR). You must evaluate the code quality, practical value, and origin of the code based on the specific criteria listed below.

# Evaluation Criteria

1.  **Summary of Changes**: Briefly summarize what this PR does (e.g., bug fix, new feature, refactoring).
2.  **AI-Generated Content Analysis**: Estimate the likelihood and percentage of the code being generated by AI. Analyze patterns such as generic variable naming, over-commenting, specific boilerplate styles, or lack of domain-specific nuance.
3.  **Engineering Reality Check**: specific analysis of whether this addresses a realistic, production-grade engineering problem. Does it handle edge cases? Is it merely a "toy example" or does it close the gap to real-world application?
4.  **Economic Value**: Assess the potential economic impact. Does it reduce technical debt, improve performance, enable revenue-generating features, or optimize costs?
5.  **Verification & Testing**: Check for the presence and quality of verification procedures (unit tests, integration tests, CI pipelines). Are the changes verifiable?
6.  **Documentation Quality**: Evaluate the presence of guiding documentation (README updates, docstrings, usage guides). Is it easy for a new developer to understand?
7.  **Organizational Structure**: Analyze the project structure. Is the file organization logical, modular, and scalable?

# Output Format Rules

1.  **Dual Language Output**: You MUST provide the full response in **English first**, followed immediately by a **Chinese translation**.
2.  **Structure**: Use Markdown headers for each section.
3.  **Tone**: Professional, critical, and objective.

# Response Template

## ğŸ‡¬ğŸ‡§ English Analysis

### 1. Executive Summary
[Brief summary here]

### 2. AI Content Analysis
* **Estimated AI Component**: [0-100%]
* **Reasoning**: [Analysis of code patterns, logic density, etc.]

### 3. Engineering & Economic Assessment
* **Engineering Gap**: [Analyze if this is a realistic engineering problem vs. theoretical/toy code]
* **Economic Value**: [High/Medium/Low - Explanation of business impact]

### 4. Quality Assurance
* **Verification**: [Analysis of tests and validation steps]
* **Documentation**: [Analysis of guides and docs]
* **Organization**: [Analysis of structure and modularity]

---

## ğŸ‡¨ğŸ‡³ ä¸­æ–‡åˆ†æ

### 1. æ‘˜è¦
[æ­¤å¤„ä¸ºæ‘˜è¦]

### 2. AI æˆåˆ†åˆ†æ
* **é¢„ä¼° AI å«é‡**: [0-100%]
* **åˆ¤æ–­ä¾æ®**: [åˆ†æä»£ç æ¨¡å¼ã€é€»è¾‘å¯†åº¦ç­‰]

### 3. å·¥ç¨‹ä¸ç»æµè¯„ä¼°
* **å·¥ç¨‹ç°å®å·®è·**: [åˆ†ææ˜¯è§£å†³å®é™…å·¥ç¨‹é—®é¢˜è¿˜æ˜¯ä»…ä¸ºç†è®º/ç©å…·ä»£ç ]
* **ç»æµä»·å€¼**: [é«˜/ä¸­/ä½ - è¯´æ˜å•†ä¸šå½±å“]

### 4. è´¨é‡ä¿è¯
* **éªŒè¯ç¨‹åº**: [åˆ†ææµ‹è¯•å’ŒéªŒè¯æ­¥éª¤]
* **æ–‡æ¡£è´¨é‡**: [åˆ†æå¼•å¯¼æ–‡æ¡£]
* **ç»„ç»‡ç»“æ„**: [åˆ†æä»£ç ç»“æ„å’Œæ¨¡å—åŒ–]

---

**Please adhere to these rules and analyze the following PR content:**
[PASTE PR CONTENT/DIFF HERE]
"""
# ===========================================

def get_pr_diff(repo, pr_number):
    pr = repo.get_pull(pr_number)
    
    headers = {
        'Authorization': f'token {os.getenv("GITHUB_TOKEN")}',
        'Accept': 'application/vnd.github.v3.diff' 
    }
    
    response = requests.get(pr.url, headers=headers)
    response.raise_for_status()
    return response.text

def analyze_code_with_llm(diff_content):
    """é€šè¿‡ OpenRouter è°ƒç”¨ LLM"""
    api_key = os.getenv("LLM_API_KEY")
    if not api_key:
        return "âŒ æ— æ³•è¿›è¡Œå®¡æŸ¥ï¼šæœªé…ç½® LLM_API_KEYã€‚"

    # OpenRouter
    url = "https://openrouter.ai/api/v1/chat/completions"
    
    # æˆªæ–­ Diff ä»¥é˜²æ­¢è¶…é•¿ (OpenRouter éƒ¨åˆ†æ¨¡å‹æ”¯æŒ 1M+ contextï¼Œä½†ä¸ºäº†çœé’±è¿˜æ˜¯æˆªæ–­ä¸€ä¸‹)
    # Gemini Flash æ”¯æŒ 1M contextï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®å¾—å¾ˆå¤§
    max_len = 32000 
    truncated_diff = diff_content[:max_len] + ("\n...(diff truncated due to length)" if len(diff_content) > max_len else "")

    payload = {
        "model": OPENROUTER_MODEL,
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": f"The following is the Diff content of the PR: \n\n```diff\n{truncated_diff}\n```"}
        ],
        # OpenRouter ç‰¹å®šå‚æ•°
        "temperature": 0.2,
        "top_p": 0.9,
    }
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}",
        "HTTP-Referer": "https://github.com/my-repo-agent", 
        "X-Title": "GitHub PR Review Agent"
    }

    try:
        response = requests.post(url, headers=headers, json=payload, timeout=120)
        
        if response.status_code != 200:
            print(f"DEBUG: OpenRouter Error Status: {response.status_code}")
            print(f"DEBUG: OpenRouter Response: {response.text}")
            response.raise_for_status()

        result = response.json()
        
        content = result['choices'][0]['message'].get('content')
        if not content:
            return "âŒ AI è¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥ OpenRouter æ—¥å¿—ã€‚"
            
        return content

    except Exception as e:
        return f"ğŸ¤– LLM è°ƒç”¨å¤±è´¥: {str(e)}"

def main():
    github_token = os.getenv("GITHUB_TOKEN")
    repo_name = os.getenv("GITHUB_REPOSITORY") 
    pr_number = os.getenv("PR_NUMBER")

    if not all([github_token, repo_name, pr_number]):
        print("Missing environment variables (GITHUB_TOKEN, GITHUB_REPOSITORY, PR_NUMBER).")
        sys.exit(1)

    try:
        auth = Auth.Token(github_token)
        g = Github(auth=auth)
        
        repo = g.get_repo(repo_name)
        pr = repo.get_pull(int(pr_number))

        print(f"ğŸš€ å¼€å§‹å®¡æŸ¥ PR #{pr_number} : {pr.title} ...")

        try:
            diff_text = get_pr_diff(repo, int(pr_number))
        except Exception as e:
            print(f"âŒ è·å– Diff å¤±è´¥: {e}")
            sys.exit(1)
        
        if not diff_text.strip():
            print("âš ï¸ Diff ä¸ºç©ºï¼Œè·³è¿‡å®¡æŸ¥ã€‚")
            return

        print(f"ğŸ“„ Diff è·å–æˆåŠŸ (é•¿åº¦: {len(diff_text)} chars)ï¼Œæ­£åœ¨å‘é€ç»™ OpenRouter ({OPENROUTER_MODEL})...")

        review_comment = analyze_code_with_llm(diff_text)
        
        print(f"âœ… å®¡æŸ¥å®Œæˆï¼Œå‡†å¤‡æäº¤è¯„è®º...")
        
        final_comment = f"## ğŸ¤– AI Code Review ({OPENROUTER_MODEL})\n\n{review_comment}"
        
        pr.create_issue_comment(final_comment)
        print("ğŸ‰ è¯„è®ºå·²å‘å¸ƒåˆ° GitHubã€‚")

    except Exception as e:
        print(f"âŒ å‘ç”Ÿæœªæ•è·é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()